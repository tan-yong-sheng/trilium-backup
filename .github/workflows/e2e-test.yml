name: E2E Tests

on:
  push:
    branches: [main, master]
    paths:
      - 'backup/**'
      - '.github/workflows/**'
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create test Trilium data
        run: |
          mkdir -p ./trilium-data
          # Create a test SQLite database
          sqlite3 ./trilium-data/document.db "
            CREATE TABLE IF NOT EXISTS test_table (id INTEGER PRIMARY KEY, name TEXT);
            INSERT INTO test_table (name) VALUES ('Test Data');
          "
          echo "test-session-secret" > ./trilium-data/session_secret.txt
          echo "[General]" > ./trilium-data/config.ini
          echo "instanceName=test" >> ./trilium-data/config.ini
          echo "noBackup=false" >> ./trilium-data/config.ini
          mkdir -p ./trilium-data/log
          echo "Test log entry" > ./trilium-data/log/test.log
          echo "Test data created successfully"
          ls -la ./trilium-data/

      - name: Build backup image
        run: |
          docker build -f ./backup/Dockerfile -t trilium-backup:test .
          echo "Backup image built successfully"
          docker images trilium-backup:test

      - name: Test 1 - Verify sqlite3 in container
        run: |
          docker run --rm trilium-backup:test sqlite3 --version
          echo "✓ sqlite3 is available in container"

      - name: Test 2 - Verify rclone in container
        run: |
          docker run --rm trilium-backup:test rclone --version
          echo "✓ rclone is available in container"

      - name: Test 3 - Verify gpg in container
        run: |
          docker run --rm trilium-backup:test gpg --version | head -1
          echo "✓ gpg is available in container"

      - name: Test 4 - Create backup
        run: |
          mkdir -p ./trilium-docker-backups
          docker run --rm \
            -v $(pwd)/trilium-data:/home/node/trilium-data:ro \
            -v $(pwd)/trilium-docker-backups:/backups \
            -e TRILIUM_DATA_DIR=/home/node/trilium-data \
            -e BACKUP_ENCRYPTION_KEY=test-encryption-key \
            -e BACKUP_SCHEDULE="0 2 * * *" \
            -e BACKUP_RETENTION_DAYS=30 \
            -e LOG_LEVEL=DEBUG \
            trilium-backup:test \
            python -c "from backup import run_backup; run_backup()"
          echo "✓ Backup created successfully"
          ls -la ./trilium-docker-backups/

      - name: Test 5 - Verify backup file exists and is encrypted
        run: |
          if [ ! -f ./trilium-docker-backups/*.gpg ]; then
            echo "✗ Encrypted backup file not found"
            exit 1
          fi
          echo "✓ Encrypted backup file exists"
          file ./trilium-docker-backups/*.gpg

      - name: Test 6 - Restore from backup
        run: |
          # Create restore directory
          mkdir -p ./trilium-data-restored

          # Find the backup file
          BACKUP_FILE=$(ls ./trilium-docker-backups/*.tar.gz.gpg | head -1)
          BACKUP_FILENAME=$(basename "$BACKUP_FILE")
          echo "Restoring from: $BACKUP_FILE"
          echo "Backup filename: $BACKUP_FILENAME"

          # Run restore using restore.py
          docker run --rm \
            -v $(pwd)/trilium-data-restored:/home/node/trilium-data \
            -v $(pwd)/trilium-docker-backups:/backups \
            -e TRILIUM_DATA_DIR=/home/node/trilium-data \
            -e BACKUP_ENCRYPTION_KEY=test-encryption-key \
            -e LOG_LEVEL=DEBUG \
            trilium-backup:test \
            python -c "from restore import run_restore; from pathlib import Path; import sys; backup_path = Path('/backups') / '${BACKUP_FILENAME}'; result = run_restore(backup_path, '/home/node/trilium-data', force=True); sys.exit(0 if result else 1)"
          echo "✓ Restore completed"

      - name: Test 7 - Verify restored data
        run: |
          echo "Checking restored files..."
          ls -la ./trilium-data-restored/

          if [ ! -f ./trilium-data-restored/document.db ]; then
            echo "✗ document.db not restored"
            exit 1
          fi
          echo "✓ document.db exists"

          if [ ! -f ./trilium-data-restored/config.ini ]; then
            echo "✗ config.ini not restored"
            exit 1
          fi
          echo "✓ config.ini exists"

          if [ ! -f ./trilium-data-restored/session_secret.txt ]; then
            echo "✗ session_secret.txt not restored"
            exit 1
          fi
          echo "✓ session_secret.txt exists"

          # Verify SQLite data integrity
          sqlite3 ./trilium-data-restored/document.db "SELECT * FROM test_table;"
          echo "✓ SQLite data is intact"

      - name: Test 8 - List backups using restore.py
        run: |
          docker run --rm \
            -v $(pwd)/trilium-docker-backups:/backups \
            -e TRILIUM_DATA_DIR=/home/node/trilium-data \
            trilium-backup:test \
            python restore.py --list --source local || true
          echo "✓ List backups command works"

      - name: Cleanup
        if: always()
        run: |
          rm -rf ./trilium-data ./trilium-data-restored ./trilium-docker-backups
          echo "Cleanup completed"

      - name: Test Summary
        run: |
          echo "======================================"
          echo "All E2E Tests Passed!"
          echo "======================================"
          echo "✓ Container builds successfully"
          echo "✓ sqlite3 available"
          echo "✓ rclone available"
          echo "✓ gpg available"
          echo "✓ Backup creation works"
          echo "✓ Backup encryption works"
          echo "✓ Restore works"
          echo "✓ Data integrity verified"
